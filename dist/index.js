"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),axios=_interopDefault(require("axios"));function __async(e){return new Promise(function(t,a){function r(n,o){try{var u=e[o?"throw":"next"](n)}catch(e){return void a(e)}u.done?t(u.value):Promise.resolve(u.value).then(r,s)}function s(e){r(e,1)}r()})}var getResponse=function(e){return e&&e.data&&e.data.response},getCategoryCounts=function(e){return __async(function(){var t,a,r,s,n;return tslib_1.__generator(this,function(o){switch(o.label){case 0:t={},o.label=1;case 1:return o.trys.push([1,3,,4]),a={"facet.multilevel":"categoryPath","f.categoryPath.nameId":"true","f.categoryPath.max.depth":4},r=tslib_1.__assign({},e.parameters,a,{start:0,rows:0,fields:"alt_img","p-id":'categoryPathId:"'+e.categoryPathL2+'"'}),[4,axios.get(e.unbxdBase+"/category",{headers:e.headers,params:r})];case 2:return(s=o.sent())&&s.data&&s.data.facets&&s.data.facets.multilevel&&s.data.facets.multilevel.bucket&&s.data.facets.multilevel.bucket.length&&s.data.facets.multilevel.bucket.forEach(function(e){e.values.forEach(function(e){var a=e.id,r=e.count;t[a]=r})}),[3,4];case 3:return n=o.sent(),[2,Promise.reject(n)];case 4:return[2,Promise.resolve(t)]}})}())},fetchL3Categories=function(e){return new Promise(function(t,a){return __async(function(){var r,s,n,o,u,c,i,l,f,d,h,g,p,_,b,y,m,v,x;return tslib_1.__generator(this,function(P){switch(P.label){case 0:return P.trys.push([0,7,,8]),s=e.parameters,n=s.start,o=s.rows,u=n+o,c=0,i=null,l=!1,f=0,d=0,h=o,[4,getCategoryCounts(e)];case 1:g=P.sent(),p=0,_=e.categoryIdsL3,P.label=2;case 2:return p<_.length?(b=_[p],(y=g[b])+c>n?(f=0,l?d=y<h?y:h:(c=y-(d=y-(f=y-(y+c-n))<h?y-f:h)-f,l=!0),[4,axios.get(e.unbxdBase+"/category",{headers:e.headers,params:tslib_1.__assign({},e.parameters,{start:f,rows:d})})]):[3,4]):[3,6];case 3:m=P.sent(),i?(v=getResponse(i),(r=v.products).push.apply(r,m.data.response.products)):i=m,h-=d,P.label=4;case 4:if((c+=y)>=u||!h)return[3,6];P.label=5;case 5:return p++,[3,2];case 6:return t(i),[3,8];case 7:return x=P.sent(),a(x),[3,8];case 8:return[2]}})}())})};exports.default=fetchL3Categories,exports.fetchL3Categories=fetchL3Categories;
