"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),axios=_interopDefault(require("axios"));function __async(e){return new Promise(function(t,a){function r(n,c){try{var o=e[c?"throw":"next"](n)}catch(e){return void a(e)}o.done?t(o.value):Promise.resolve(o.value).then(r,s)}function s(e){r(e,1)}r()})}var getResponse=function(e){return e&&e.data&&e.data.response},getCategoryCounts=function(e){return __async(function(){var t,a,r,s,n;return tslib_1.__generator(this,function(c){switch(c.label){case 0:t={},c.label=1;case 1:return c.trys.push([1,3,,4]),a={"facet.multilevel":"categoryPath","f.categoryPath.nameId":"true","f.categoryPath.max.depth":4},r=tslib_1.__assign({},e.parameters,a,{start:0,rows:0,fields:"alt_img","p-id":'categoryPathId:"'+e.categoryPathL2+'"'}),[4,axios.get(e.unbxdBase+"/category",{headers:e.headers,params:r})];case 2:return(s=c.sent())&&s.data&&s.data.facets&&s.data.facets.multilevel&&s.data.facets.multilevel.bucket&&s.data.facets.multilevel.bucket.length&&s.data.facets.multilevel.bucket.forEach(function(e){e.values.forEach(function(e){var a=e.id,r=e.count;t[a]=r})}),[3,4];case 3:return n=c.sent(),[2,Promise.reject(n)];case 4:return[2,Promise.resolve(t)]}})}())},fetchL3Categories=function(e){return new Promise(function(t,a){return __async(function(){var r,s,n,c,o,u,i,l,f,d,h,g,p,_,b,y,m,v,P,x;return tslib_1.__generator(this,function(w){switch(w.label){case 0:return w.trys.push([0,7,,8]),s=e.parameters,n=s.start,c=s.rows,o=n+c,u=0,i=null,l=!1,f=0,d=0,h=c,[4,getCategoryCounts(e)];case 1:g=w.sent(),p=Object.keys(g).reduce(function(e,t){return e+g[t]},0),_=0,b=e.categoryIdsL3,w.label=2;case 2:return _<b.length?(y=b[_],(m=g[y])+u>n?(f=0,l?d=m<h?m:h:(u=m-(d=m-(f=m-(m+u-n))<h?m-f:h)-f,l=!0),[4,axios.get(e.unbxdBase+"/category",{headers:e.headers,params:tslib_1.__assign({},e.parameters,{"p-id":'categoryPathId:"'+e.categoryPathL2+">"+y+'"',start:f,rows:d})})]):[3,4]):[3,6];case 3:v=w.sent(),i?(P=getResponse(i),(r=P.products).push.apply(r,v.data.response.products)):i=v,h-=d,w.label=4;case 4:if((u+=m)>=o||!h)return[3,6];w.label=5;case 5:return _++,[3,2];case 6:return i?i.data.response.numberOfProducts=p:i={data:{response:{numberOfProducts:0,products:[],start:0},facets:{},searchMetaData:{}}},t(i),[3,8];case 7:return x=w.sent(),a(x),[3,8];case 8:return[2]}})}())})};exports.default=fetchL3Categories,exports.fetchL3Categories=fetchL3Categories;
